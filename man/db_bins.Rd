% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/db_bins.R
\name{db_bins}
\alias{db_bins}
\title{Database-native binned regression}
\usage{
db_bins(
  data,
  y,
  x,
  B = 20,
  degree = 1,
  smooth = 0,
  controls = NULL,
  fe = NULL,
  weights = NULL,
  partition = c("quantile", "equal", "log_equal", "manual"),
  breaks = NULL,
  engine = c("design_ols", "moments_kkt"),
  strategy = "auto",
  conn = NULL,
  verbose = TRUE
)
}
\arguments{
\item{data}{A data source: R dataframe, database table name (character), or
dplyr::tbl object pointing to a database table.}

\item{y}{Character string or unquoted name of the outcome variable.}

\item{x}{Character string or unquoted name of the binning variable.}

\item{B}{Integer number of bins. Default is 20.}

\item{degree}{Polynomial degree within bins: 0 (means), 1 (linear), or 2
(quadratic). Default is 1.}

\item{smooth}{Smoothness at bin boundaries: 0 (discontinuous), 1 (continuous
level), or 2 (continuous level and slope). Must satisfy `smooth <= degree`.
Default is 0. Note: `smooth > 0` requires `engine = "moments_kkt"` (not yet
implemented).}

\item{controls}{Optional formula specifying control variables, e.g. `~ z1 + z2`.
Default is NULL (no controls).}

\item{fe}{Optional formula specifying fixed effects using dbreg syntax, e.g.
`~ id + time`. Default is NULL (no fixed effects).}

\item{weights}{Character string naming the weight column. Default is NULL
(equal weights).}

\item{partition}{Bin partitioning method: "quantile" (equal-count bins),
"equal" (equal-width bins), "log_equal" (equal-width in log-space, for
right-skewed variables; requires x > 0), or "manual" (user-specified breaks).
Default is "quantile".}

\item{breaks}{Numeric vector of breakpoints if `partition = "manual"`.
Ignored otherwise.}

\item{engine}{Estimation engine: "design_ols" (formula-based, uses existing
dbreg infrastructure) or "moments_kkt" (moment-based with smoothness
constraints; not yet implemented). Default is "design_ols".}

\item{strategy}{Acceleration strategy passed to dbreg when `engine = "design_ols"`.
Default is "auto". See \code{\link{dbreg}} for details.}

\item{conn}{Database connection. If NULL (default), an ephemeral DuckDB
connection will be created.}

\item{verbose}{Logical. Print progress messages? Default is TRUE.}
}
\value{
A tibble with bin-level results containing:
  - `bin`: bin number (1 to B)
  - `x_left`, `x_right`, `x_mid`: bin boundaries and midpoint
  - `n`: number of observations in bin
  - If `degree = 0`: `y` (fitted value at `x_mid`)
  - If `degree >= 1`: `y_left`, `y_right` (fitted values at bin boundaries,
    defining a line segment)
  - Plus metadata: `B`, `degree`, `smooth`, `partition`
}
\description{
Performs binned regression entirely in SQL, returning plot-ready data with
estimated bin means or piecewise polynomial fits. Supports unconditional and
conditional models (with controls and/or fixed effects).
}
\examples{
\dontrun{
# Simple bin means
db_bins(mtcars, mpg, wt, B = 10, degree = 0)

# Piecewise linear fit
db_bins(mtcars, mpg, wt, B = 10, degree = 1)

# With controls
db_bins(mtcars, mpg, wt, controls = ~ hp + cyl, B = 10, degree = 1)
}
}

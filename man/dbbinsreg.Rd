% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/dbbinsreg.R
\name{dbbinsreg}
\alias{dbbinsreg}
\title{Database-native binned regression (binsreg-compatible API)}
\usage{
dbbinsreg(
  fml,
  data,
  dots = c(0, 0),
  line = NULL,
  linegrid = 20,
  nbins = 20,
  binspos = "qs",
  sample_frac = NULL,
  ci = TRUE,
  vcov = NULL,
  level = 95,
  strategy = "auto",
  conn = NULL,
  verbose = TRUE
)
}
\arguments{
\item{fml}{A \code{\link[stats]{formula}} representing the binscatter relation.
The first variable on the RHS is the running variable; additional variables
are controls. Fixed effects go after \code{|}. Examples:
\itemize{
\item \code{y ~ x}: simple binscatter
\item \code{y ~ x + w1 + w2}: binscatter with controls
\item \code{y ~ x | fe}: binscatter with fixed effects
\item \code{y ~ x + w1 + w2 | fe}: binscatter with controls and fixed effects
}}

\item{data}{A data source: R dataframe, database table name (character), or
a lazy table object (e.g., from \code{dplyr::tbl()}) pointing to a database table.}

\item{dots}{A vector \code{c(p, s)} specifying the polynomial degree \code{p} and smoothness
\code{s} for the dots (point estimates at bin means). Default is \code{c(0, 0)} for
canonical binscatter (bin means). Set to \code{NULL} or \code{FALSE} to suppress dots.
The smoothness \code{s} must satisfy \code{s <= p}.}

\item{line}{A vector \code{c(p, s)} specifying the polynomial degree \code{p} and smoothness
\code{s} for the line (evaluated on a grid within bins). Default is \code{NULL} (no line).
Set to \code{TRUE} for \code{c(0, 0)} or a vector like \code{c(1, 1)} for piecewise linear
with continuity constraints. The smoothness \code{s} must satisfy \code{s <= p}.}

\item{linegrid}{Number of evaluation points per bin for the line. Default is 20.}

\item{nbins}{Integer number of bins. Default is 20.}

\item{binspos}{Bin positioning method: "qs" (quantile-spaced, equal-count bins,
the default), "es" (evenly-spaced, equal-width bins), or a numeric vector of
knot positions for manual specification.}

\item{sample_frac}{Numeric between 0 and 1, or NULL (default). Controls
sampling for bin boundary computation on large datasets. If NULL, sampling
is automatic: 10\% for datasets exceeding 1 million rows, 100\% otherwise.
Set explicitly to override (e.g., 1 to always use all data, 0.05 for 5\%).
Sampling only affects bin boundary computation; the regression uses all data.}

\item{ci}{Logical. Calculate standard errors and confidence intervals for dots?
Default is TRUE.}

\item{vcov}{Character string or formula for standard errors. Options are
"HC1" (default, heteroskedasticity-robust, matches binsreg), "iid", or a
clustering formula like ~cluster_var.}

\item{level}{Confidence level as a percentage (e.g., 95 for 95\% CI). Default is 95.}

\item{strategy}{Acceleration strategy passed to dbreg when smoothness is 0.
Options are "auto" (default), "compress", or "scan". This parameter is
ignored when \code{s} (smoothness parameter in \code{dots} or \code{lines}) > 0. See \code{\link{dbreg}} for details.}

\item{conn}{Database connection. If NULL (default), an ephemeral DuckDB
connection will be created.}

\item{verbose}{Logical. Print progress messages? Default is TRUE.}
}
\value{
A list of class "dbbinsreg" containing:
\describe{
\item{data.dots}{Data frame with dot estimates (one row per bin): \code{x} (bin mean),
\code{bin}, \code{fit} (fitted value), and if \code{ci=TRUE}: \code{se}, \code{ci.l}, \code{ci.r}.}
\item{data.line}{Data frame with line estimates (multiple rows per bin): \code{x},
\code{bin}, \code{fit}. Only present if \code{line} is specified.}
\item{data.bin}{Data frame with bin geometry: \code{bin.id}, \code{left.endpoint},
\code{right.endpoint}.}
\item{model}{The fitted dbreg model object (for dots).}
\item{opt}{List of options used: \code{dots}, \code{line}, \code{nbins}, \code{binspos}, etc.}
}
}
\description{
Performs binned regression entirely in SQL, returning plot-ready data with
estimated bin means or piecewise polynomial fits. The API is designed to be compatible
with the \pkg{binsreg} package by Cattaneo, Crump, Farrell, and Feng (2024).
Supports unconditional and conditional models (with controls and/or fixed effects).
}
\details{
\subsection{Relationship to binsreg}{

This function aims to provide an API similar to the \pkg{binsreg} package.
Key parameter mappings:
\itemize{
\item \code{dots=c(0,0)}: Canonical binscatter (bin means), equivalent to binsreg default
\item \code{dots=c(p,0)}: Piecewise polynomial of degree p, no smoothness constraints
\item \code{dots=c(p,s)}: Piecewise polynomial with s smoothness constraints at knots
\item \code{line=c(p,s)}: Same polynomial evaluated on a grid for smooth visualization
\item \code{binspos="qs"}: Quantile-spaced bins (binsreg default)
\item \code{binspos="es"}: Evenly-spaced bins
}

Unlike binsreg, dbbinsreg executes entirely in SQL, making it suitable for large
databases that cannot fit in memory.
}

\subsection{Note on quantile bin boundaries}{

When using quantile-spaced bins (\code{binspos="qs"}), dbbinsreg uses SQL's \code{NTILE()}
window function, while binsreg uses R's \code{quantile()} with
\code{type=2}. These algorithms have slightly different tie-breaking behavior,
which can cause small differences in bin assignments at boundaries. In
practice, differences are typically <1\% and become negligible with larger
datasets. To match binsreg exactly, compute quantile breaks on a subset
of data in R and pass them via the \code{binspos} argument as a numeric vector.
}
}
\examples{
\dontrun{
ChickWeight = as.data.frame(ChickWeight)

# Canonical binscatter: bin means (default)
dbbinsreg(weight ~ Time, ChickWeight, nbins = 10)

# Piecewise linear, no smoothness
dbbinsreg(weight ~ Time, ChickWeight, nbins = 10, dots = c(1, 0))

# Piecewise quadratic with C1 continuity
dbbinsreg(weight ~ Time, ChickWeight, nbins = 10, dots = c(2, 1))

# With line overlay for smooth visualization
dbbinsreg(weight ~ Time, ChickWeight, nbins = 10, dots = c(0, 0), line = c(1, 1))

# With fixed effects (diet type)
dbbinsreg(weight ~ Time | Diet, ChickWeight, nbins = 10, dots = c(1, 0))
}
}
\references{
Cattaneo, M. D., R. K. Crump, M. H. Farrell, and Y. Feng (2024).
On Binscatter. \emph{American Economic Review}, 114(5): 1488-1514.
}
